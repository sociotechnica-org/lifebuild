#!/usr/bin/env bash
set -euo pipefail

# Factory History — Trend analysis from accumulated snapshots
# Reads .context/factory-snapshots.jsonl and shows trends over time.
#
# Usage:
#   ./scripts/factory-history              # Show all trends
#   ./scripts/factory-history --last 7     # Last 7 snapshots
#   ./scripts/factory-history --velocity   # Decision velocity only

# ─── Config ──────────────────────────────────────────────────────────────────
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
SNAPSHOT_FILE="${FACTORY_SNAPSHOT_FILE:-$REPO_ROOT/.context/factory-snapshots.jsonl}"
LAST_N=0  # 0 = all
SECTION="all"

# ─── Args ────────────────────────────────────────────────────────────────────
while [[ $# -gt 0 ]]; do
  case "$1" in
    --last)     LAST_N="$2"; shift 2 ;;
    --velocity) SECTION="velocity"; shift ;;
    --wip)      SECTION="wip"; shift ;;
    --blocked)  SECTION="blocked"; shift ;;
    --help)     echo "Usage: factory-history [--last N] [--velocity|--wip|--blocked]"; exit 0 ;;
    *)          shift ;;
  esac
done

# ─── Colors ──────────────────────────────────────────────────────────────────
if [[ -t 1 ]]; then
  BOLD='\033[1m'
  DIM='\033[2m'
  RED='\033[0;31m'
  GREEN='\033[0;32m'
  YELLOW='\033[0;33m'
  CYAN='\033[0;36m'
  NC='\033[0m'
else
  BOLD='' DIM='' RED='' GREEN='' YELLOW='' CYAN='' NC=''
fi

# ─── Check data exists ──────────────────────────────────────────────────────
if [[ ! -f "$SNAPSHOT_FILE" ]]; then
  echo "No snapshot data found at $SNAPSHOT_FILE"
  echo "Run ./scripts/factory-dashboard first to create snapshots."
  exit 1
fi

SNAP_COUNT=$(wc -l < "$SNAPSHOT_FILE" | tr -d ' ')

if [[ $SNAP_COUNT -eq 0 ]]; then
  echo "Snapshot file is empty. Run ./scripts/factory-dashboard first."
  exit 1
fi

# ─── Load snapshots ─────────────────────────────────────────────────────────
load_snapshots() {
  if [[ $LAST_N -gt 0 ]]; then
    tail -n "$LAST_N" "$SNAPSHOT_FILE"
  else
    cat "$SNAPSHOT_FILE"
  fi
}

# ─── Header ──────────────────────────────────────────────────────────────────
show_header() {
  printf "\n${BOLD}FACTORY HISTORY${NC}"
  if [[ $LAST_N -gt 0 ]]; then
    printf " (last %s snapshots)" "$LAST_N"
  fi
  printf "\n"
  printf "${DIM}%s snapshots from %s${NC}\n" "$SNAP_COUNT" "$SNAPSHOT_FILE"
  printf "================================================================\n"
}

# ─── Blocked Trend ───────────────────────────────────────────────────────────
show_blocked_trend() {
  printf "\n${BOLD}BLOCKED COUNT TREND${NC}\n"
  printf "────────────────────────────────────────────────────────────────\n"

  load_snapshots | jq -r '
    "\(.timestamp | split("T")[0]) \(.timestamp | split("T")[1] | split(".")[0] | .[:5])  blocked: \(.blocked)/\(.total)  (\(.blocked * 100 / (if .total > 0 then .total else 1 end) | floor)%)"
  ' | while read -r line; do
    printf "  %s\n" "$line"
  done

  # Show delta if 2+ snapshots
  if [[ $SNAP_COUNT -ge 2 ]]; then
    local first_blocked last_blocked
    first_blocked=$(head -1 "$SNAPSHOT_FILE" | jq '.blocked')
    last_blocked=$(tail -1 "$SNAPSHOT_FILE" | jq '.blocked')
    local delta=$(( last_blocked - first_blocked ))
    printf "\n  ${BOLD}Delta:${NC} "
    if [[ $delta -gt 0 ]]; then
      printf "${RED}+%s${NC} (getting worse)\n" "$delta"
    elif [[ $delta -lt 0 ]]; then
      printf "${GREEN}%s${NC} (improving)\n" "$delta"
    else
      printf "0 (unchanged)\n"
    fi
  fi
}

# ─── WIP Trend ───────────────────────────────────────────────────────────────
show_wip_trend() {
  printf "\n${BOLD}WIP BALANCE TREND${NC}\n"
  printf "────────────────────────────────────────────────────────────────\n"

  printf "  ${DIM}%-12s  %7s  %7s  %7s  %7s${NC}\n" "Date" "DECIDE" "PATCH" "MAKE" "SHAPE"
  printf "  ${DIM}%-12s  %7s  %7s  %7s  %7s${NC}\n" "────────────" "───────" "───────" "───────" "───────"

  load_snapshots | jq -r '
    "\(.timestamp | split("T")[0])  \(.wip.DECIDE // 0)  \(.wip.PATCH // 0)  \(.wip.MAKE // 0)  \(.wip.SHAPE // 0)"
  ' | while read -r date decide patch make shape; do
    printf "  %-12s  %7s  %7s  %7s  %7s\n" "$date" "$decide" "$patch" "$make" "$shape"
  done
}

# ─── Decision Velocity ───────────────────────────────────────────────────────
show_velocity() {
  printf "\n${BOLD}DECISION VELOCITY${NC}\n"
  printf "────────────────────────────────────────────────────────────────\n"

  if [[ $SNAP_COUNT -lt 2 ]]; then
    printf "  ${DIM}Need 2+ snapshots to calculate velocity.${NC}\n"
    printf "  ${DIM}Run ./scripts/factory-dashboard daily to accumulate data.${NC}\n"
    printf "\n  Current: "
    local resolved total
    resolved=$(tail -1 "$SNAPSHOT_FILE" | jq '.decisions.resolved')
    total=$(tail -1 "$SNAPSHOT_FILE" | jq '.decisions.total')
    printf "${BOLD}%s/%s${NC} decisions resolved\n" "$resolved" "$total"
    return
  fi

  # Show decisions resolved between each pair of snapshots
  load_snapshots | jq -rs '
    . as $all |
    [range(1; length) |
      {
        from: $all[. - 1].timestamp,
        to: $all[.].timestamp,
        resolved_before: $all[. - 1].decisions.resolved,
        resolved_after: $all[.].decisions.resolved,
        delta: ($all[.].decisions.resolved - $all[. - 1].decisions.resolved)
      }
    ] |
    .[] |
    "\(.from | split("T")[0])  ->  \(.to | split("T")[0])    +\(.delta) decisions"
  ' | while read -r line; do
    printf "  %s\n" "$line"
  done

  # Calculate average velocity
  local avg
  avg=$(load_snapshots | jq -rs '
    if length < 2 then 0
    else
      (last.decisions.resolved - first.decisions.resolved) as $total_resolved |
      (
        ((last.timestamp | split("T")[0] | split("-") | map(tonumber) | .[0]*365 + .[1]*30 + .[2]) -
         (first.timestamp | split("T")[0] | split("-") | map(tonumber) | .[0]*365 + .[1]*30 + .[2])) / 7
      ) as $weeks |
      if $weeks > 0 then ($total_resolved / $weeks * 100 | floor / 100)
      else $total_resolved end
    end
  ')

  printf "\n  ${BOLD}Avg velocity:${NC} ~%s decisions/week\n" "$avg"
  printf "  ${DIM}Target: 5-6/week. Below 1/week = factory is starving.${NC}\n"
}

# ─── Flow State Breakdown ───────────────────────────────────────────────────
show_flow_breakdown() {
  printf "\n${BOLD}FLOW STATE BREAKDOWN${NC} (latest snapshot)\n"
  printf "────────────────────────────────────────────────────────────────\n"

  tail -1 "$SNAPSHOT_FILE" | jq -r '
    .byFlowState | to_entries | sort_by(-.value) | .[] |
    "  \(.key): \(.value)"
  '
}

# ─── Item Movement ───────────────────────────────────────────────────────────
show_item_movement() {
  if [[ $SNAP_COUNT -lt 2 ]]; then
    return
  fi

  printf "\n${BOLD}ITEM MOVEMENT${NC} (since first snapshot)\n"
  printf "────────────────────────────────────────────────────────────────\n"

  # Compare first and last snapshots to find items that changed station/flow
  local first_snap last_snap
  first_snap=$(head -1 "$SNAPSHOT_FILE")
  last_snap=$(tail -1 "$SNAPSHOT_FILE")

  echo "$first_snap" | jq -r --argjson last "$last_snap" '
    .items as $old_items |
    $last.items as $new_items |
    [
      $new_items[] |
      . as $new |
      ($old_items | map(select(.number == $new.number)) | first) as $old |
      if $old then
        if $old.flowState != $new.flowState or $old.station != $new.station then
          "  #\($new.number)  \($new.title | if length > 30 then .[:27] + "..." else . end)  \($old.station)/\($old.flowState) -> \($new.station)/\($new.flowState)"
        else empty end
      else
        "  #\($new.number)  \($new.title | if length > 30 then .[:27] + "..." else . end)  (new)"
      end
    ] | .[]
  ' 2>/dev/null || printf "  ${DIM}(Could not compute movement)${NC}\n"
}

# ─── Main ────────────────────────────────────────────────────────────────────
main() {
  show_header

  case "$SECTION" in
    velocity)
      show_velocity
      ;;
    wip)
      show_wip_trend
      ;;
    blocked)
      show_blocked_trend
      ;;
    all)
      show_blocked_trend
      show_wip_trend
      show_velocity
      show_flow_breakdown
      show_item_movement
      ;;
  esac

  printf "\n"
}

main "$@"
