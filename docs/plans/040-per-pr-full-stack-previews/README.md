# Per-PR Full-Stack Preview Environments

## Status

In Progress (PR A and PR B implemented; cleanup hardening remains)

## Date

2026-02-10

## Related Issues

- `#536` Set up preview deployments for each Pull Request
- `#31` Staging environment context (older assumptions around DO preview behavior)

## Goal

For every PR, automatically provision an end-to-end preview stack that includes:

- Web (Cloudflare Pages branch preview)
- Sync worker (Cloudflare Worker + Durable Object)
- Auth worker (Cloudflare Worker + Durable Object)
- Server (Render preview environment)

Reviewers should get one PR comment with all preview URLs and be able to test real flows without local setup.

## Non-Goals

- Production deployment changes
- Data migration for existing production services
- Guaranteed support for untrusted fork PRs (covered as a policy decision)
- PostHog analytics in preview environments (explicitly excluded)

## Current Constraints

1. Sync/Auth Workers use Durable Objects in this repo:
   - `packages/worker/wrangler.jsonc`
   - `packages/auth-worker/wrangler.toml`
2. Cloudflare Worker preview URLs do not apply to Workers that implement Durable Objects.
3. Current CI deploys only on `main` (`.github/workflows/deploy.yml`).
4. Current server deployment config (`packages/server/render.yaml`) is production-pinned.

## Target Architecture

For PR `N`:

- Web preview: Cloudflare Pages branch preview for branch `pr-N`
- Sync preview worker: `lifebuild-sync-pr-N` on `workers.dev`
- Auth preview worker: `lifebuild-auth-pr-N` on `workers.dev`
- Server preview: Render preview environment for PR branch

### URL Pattern (Deterministic)

- Sync: `https://lifebuild-sync-pr-N.<workers-subdomain>.workers.dev`
- Auth: `https://lifebuild-auth-pr-N.<workers-subdomain>.workers.dev`
- Web: Cloudflare Pages branch preview URL for `pr-N`
- Server: Render preview URL generated by Render for PR environment

## Environment and Data Model

### Recommended baseline (Phase 1)

Use a shared preview data plane that is separate from production:

- One preview D1 database (shared across PR workers)
- One preview KV namespace (shared across PR workers)
- One preview R2 bucket(s)

This is faster to operate and sufficient for functional PR validation. If we need hard isolation later, we can move to per-PR resources.

### Secrets and variables per PR worker

Both preview workers need non-production values for:

- `JWT_SECRET`
- `SERVER_BYPASS_TOKEN`
- Any webhook/auth secrets required for server integration

Web preview build needs:

- `VITE_AUTH_SERVICE_URL` -> PR auth worker URL
- `VITE_LIVESTORE_SYNC_URL` -> PR sync worker URL
- `VITE_REQUIRE_AUTH=true`

Server preview needs:

- `AUTH_WORKER_INTERNAL_URL` -> PR auth worker URL
- `LIVESTORE_SYNC_URL` -> PR sync worker URL
- `SERVER_BYPASS_TOKEN` matching preview workers

## Deployment Workflows

## Workflow A: Deploy/Update previews on PR open/sync/reopen

Create `.github/workflows/pr-preview.yml`:

Triggers:

- `pull_request` types: `opened`, `synchronize`, `reopened`

High-level steps:

1. Compute `PR_NUMBER` and shared names (`lifebuild-*-pr-<number>`).
2. Deploy auth preview worker with explicit worker name.
3. Deploy sync preview worker with explicit worker name.
4. Build web using PR worker URLs and deploy Pages branch preview (`--branch pr-<number>`).
5. Ensure Render preview exists/updates for the PR branch (Render-native preview environments).
6. Post or update a sticky PR comment with all preview URLs.

Implementation detail:

- Prefer explicit preview wrangler configs (no production `routes`) and `wrangler deploy --name ...`.
- Keep production configs untouched.

## Workflow B: Cleanup previews on PR close/merge

Create `.github/workflows/pr-preview-cleanup.yml`:

Triggers:

- `pull_request` type: `closed`

High-level steps:

1. Delete auth preview worker `lifebuild-auth-pr-<number>`.
2. Delete sync preview worker `lifebuild-sync-pr-<number>`.
3. Delete or age out Pages branch preview deployments for `pr-<number>` asynchronously. Immediate deletion is not required, but resource cleanup is required.
4. Render preview should auto-destroy if configured natively.

## Render Integration Plan

Use Render preview environments as the source of truth for server previews.

Required behavior:

- Preview created per PR branch
- Preview destroyed on PR close
- Render publishes GitHub deployment statuses with `environment_url`, so the PR comment can link to the preview URL without hardcoded templates

Implementation approach:

1. Keep Render preview environments as the server deployment mechanism.
2. Resolve Render preview URL in CI from GitHub deployment statuses for the PR head SHA.
3. Show "awaiting deployment status" in PR comment when Render has not reported URL yet.

## Manual Setup Required (Operator Checklist)

These steps require dashboard/org-level access and are not fully automatable from repo code alone.

1. ✅ Enable Render preview environments for the server service.
2. Confirm Render plan/features support preview environments in the current workspace.
3. Create Cloudflare preview resources (D1/KV/R2) separate from production.
4. Add GitHub Actions secrets for Cloudflare credentials scoped for preview deploys.
5. Add preview secret material (`JWT_SECRET`, `SERVER_BYPASS_TOKEN`, etc.) for workers/server.
6. Confirm workers.dev subdomain to build deterministic preview URLs.
7. Choose fork PR policy:
   - `internal-only previews` (recommended first)
   - or separate trusted workflow for forks
8. No PostHog preview setup required (analytics excluded from preview environments).

## Security and Policy Decisions

## Fork PRs

Default recommendation: do not deploy full preview infra for forked PRs because secrets are not exposed to fork workflows by default.

Policy options:

- Skip deployment for forks and comment with reason.
- Allow maintainer-triggered trusted workflow for selected forks.

## Secret handling

- Never echo secret values in logs.
- Use masked secrets only.
- Keep preview secrets distinct from production secrets.

## Failure behavior

- If one component fails, update PR comment with partial status and actionable failure section.
- Do not silently report success.

## Decisions Confirmed (2026-02-10)

1. PostHog analytics are dropped for preview environments.
2. Shared preview data plane is approved for now.
3. Server preview availability is optional for merge readiness in initial rollout.
4. Preview resources should be cleaned up after PR close; delayed cleanup is acceptable as long as resources are eventually freed.
5. Render automatic per-PR previews are enabled in the dashboard.

## Rollout Plan

### Phase 0: Prep

- Complete manual setup checklist.
- Validate credentials and resource IDs.

### Phase 1: CI scaffolding

- Add preview deploy + cleanup workflows.
- Add deterministic naming helpers and PR comment update logic.

### Phase 2: Worker previews

- Deploy auth/sync workers per PR.
- Verify WebSocket connectivity and auth flow manually in one PR.

### Phase 3: Web preview wiring

- Inject PR worker URLs into web build.
- Verify full web -> auth -> sync path.

### Phase 4: Render preview wiring

- [x] Validate Render previews against PR auth/sync endpoints.
- [x] Confirm PR comment resolves Render preview URL from GitHub deployment statuses.
- [x] Add server runtime override logic so preview servers target `lifebuild-*-pr-<PR_NUMBER>` workers automatically.

### Phase 5: Hardening

- Add retry/idempotency around deploy steps.
- Improve comment quality and diagnostics.
- Add periodic cleanup reconciliation for delayed/stale preview resources.

## Acceptance Criteria

1. Every internal PR automatically receives a preview comment with web/auth/sync/server URLs.
2. Preview stack exercises real auth + websocket sync + server integration.
3. Preview resources are cleaned up automatically when PR closes.
4. Production services and data remain isolated from preview workloads.
5. Failed preview steps are visible in PR checks and comments.
6. Server preview is non-blocking for merge during initial rollout.

## Risks and Mitigations

- Worker sprawl from stale previews:
  - Mitigate with cleanup workflow and periodic reconciliation job.
- Cross-PR data interference (shared preview DB):
  - Mitigate with namespace/store ID conventions.
- Render/Cloudflare drift (one side deploys, other fails):
  - Mitigate with explicit health links in PR comment and fail-fast checks.
- Secret mismatch (`SERVER_BYPASS_TOKEN`, JWT secrets):
  - Mitigate with a smoke check endpoint and standardized preview secret set.

## Proposed Follow-up Implementation PRs

1. PR A: Add workflows + docs + PR comment plumbing (no server code change).
2. PR B: Harden Render URL resolution and preview env wiring for server -> auth/sync endpoints. ✅
3. PR C: Add cleanup reconciliation and hardening.

## References

- Cloudflare Worker previews (limitations)
  - https://developers.cloudflare.com/workers/configuration/previews/
- Cloudflare Wrangler environments/configuration
  - https://developers.cloudflare.com/workers/wrangler/configuration/
- Cloudflare Pages branch previews
  - https://developers.cloudflare.com/pages/configuration/git-integration/
- Render preview environments
  - https://render.com/docs/preview-environments
- Related issue
  - https://github.com/sociotechnica-org/lifebuild/issues/536
