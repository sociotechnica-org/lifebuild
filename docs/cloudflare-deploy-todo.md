# Cloudflare Deployment TODO

This document outlines the steps required to deploy the Work Squared application to Cloudflare. The goal is to deploy the Vite-based frontend and the Cloudflare Worker backend together, while preserving the local development workflow.

## Running Modes

### Local Development

For local development, we will continue to use the existing setup that runs a Vite dev server for the frontend and a local Wrangler instance for the worker.

- **Command:** `pnpm dev`
- **Frontend:** Runs on `http://localhost:5173` (or another port if configured).
- **Backend:** Wrangler runs a local server for the worker on `http://localhost:8787`.
- **Environment:** The `VITE_LIVESTORE_SYNC_URL` must be set to the local worker URL (e.g., `export VITE_LIVESTORE_SYNC_URL='http://localhost:8787'`).

This setup allows for hot-reloading and rapid development of both the frontend and the worker.

### Production Deployment

For production, we will use a single command to build the frontend, and deploy both the static assets and the worker to Cloudflare.

- **Command:** `pnpm wrangler:deploy`
- **Frontend:** The Vite application will be built into a static `dist` folder and deployed to Cloudflare Pages.
- **Backend:** The worker will be deployed to Cloudflare's global network.
- **Environment:** The `VITE_LIVESTORE_SYNC_URL` will be set to the production URL. Since the frontend and worker will be served from the same domain, we can use a relative path for the WebSocket URL (e.g., '/'). This will be configured in Cloudflare.

## Tasks

### 1. Configure `wrangler.toml` for Cloudflare Pages & Workers

The current `wrangler.toml` only configures the Cloudflare Worker. We need to update it to also serve the static assets generated by Vite using Cloudflare Pages.

- **Add Pages configuration:** Add a `[pages]` section to `wrangler.toml` to define the build command and the output directory for the Vite application.
- **Consolidate configuration:** Ensure that both the Worker and the Pages application are defined in the same `wrangler.toml` for a unified deployment. The `wrangler deploy` command will then deploy both.

### 2. Configure Environment Variables with `.env`

We will use `.env` files to manage environment variables. This provides a more robust and standard way to handle configuration than using shell `export` commands.

- **Create `.env.example`:** Add a `.env.example` file to the project root to document required variables like `VITE_LIVESTORE_SYNC_URL`. This will be committed to source control.
- **Use `.env` for Local Development:** Developers will create a `.env` file for their local setup. Wrangler automatically loads variables from this file for local development, making it easy to configure the local sync URL.
- **Update `.gitignore`:** Add `.env` to `.gitignore` to prevent committing local configurations and secrets.
- **Production Variables:** For production, variables will be configured as secrets in the Cloudflare dashboard. The `.env.example` file will serve as a clear reference for which variables need to be set in the production environment.

### 3. Update Build Scripts

- The `package.json` `build` script (`vite build`) is correct for building the frontend.
- The `wrangler:deploy` script (`wrangler deploy`) will be used to deploy both the frontend and worker once `wrangler.toml` is configured correctly.

### 4. Deployment Process

The final deployment process will be:

1.  The `pnpm wrangler:deploy` command will be executed.
2.  Wrangler will first build the Vite application by running the command specified in the `[pages]` section of `wrangler.toml`.
3.  Wrangler will then upload the static assets from the specified directory (e.g., `dist`) to Cloudflare Pages.
4.  Wrangler will deploy the Cloudflare Worker, including the Durable Object and D1 database bindings.
5.  Environment variables for both the Pages frontend and the Worker will be configured in the Cloudflare dashboard.
