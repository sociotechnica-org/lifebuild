previews:
  generation: automatic
  expireAfterDays: 3

services:
  - type: web
    name: lifebuild-server
    runtime: node
    plan: starter
    previews:
      plan: starter
      numInstances: 1
    # Build from monorepo root to access workspace dependencies
    rootDir: .
    buildCommand: ./packages/server/scripts/build.sh
    startCommand: pnpm --filter @lifebuild/server start
    envVars:
      # Create this as a manually managed Render Environment Group.
      # Required keys:
      # - CLOUDFLARE_PREVIEW_WORKERS_SUBDOMAIN
      # - PREVIEW_SERVER_BYPASS_TOKEN
      - fromGroup: lifebuild-preview-overrides
      - key: NODE_ENV
        value: production
      - key: PORT
        fromService:
          type: web
          name: lifebuild-server
          property: port
      - key: LIVESTORE_SYNC_URL
        value: wss://sync.lifebuild.me
      - key: SERVER_BYPASS_TOKEN
        sync: false
      - key: AUTH_WORKER_INTERNAL_URL
        value: https://auth.lifebuild.me
      - key: CLOUDFLARE_PREVIEW_WORKERS_SUBDOMAIN
        sync: false # Required in Render preview envs to derive PR-specific worker URLs
      - key: STORE_IDS
        value: lifebuild-production,885773a8-b433-47bd-8ee4-a907a79922d8,11d1a22c-3462-43aa-988a-3cf11b95f03b,d56d28db-bc17-406d-8204-4dd24d17c5ac,70fb4e45-7677-4b70-9e46-3c2e4f3cbd0a
      - key: STORE_DATA_PATH
        value: /var/data
      # Message processing cutoff - messages before this timestamp are skipped (temporary)
      - key: MESSAGE_PROCESSING_CUTOFF_TIMESTAMP
        value: 2025-09-01T00:00:00.000Z
      # Store Connection Settings
      - key: STORE_CONNECTION_TIMEOUT
        value: 30000
      - key: STORE_RECONNECT_INTERVAL
        value: 5000
      - key: STORE_MAX_RECONNECT_ATTEMPTS
        value: 3
      - key: WORKSPACE_RECONCILE_INTERVAL_MS
        value: 300000
      - key: MANUAL_RECONCILE_MIN_INTERVAL_MS
        value: 60000
      - key: ORCHESTRATION_INCIDENT_DASHBOARD_URL
        sync: false # Populate with the Render/observability dashboard URL
      # DevTools (disabled in production)
      - key: DISABLE_DEVTOOLS
        value: true
      # BRAINTRUST credentials for server-side agentic loop
      - key: BRAINTRUST_API_KEY
        sync: false # Add via Render dashboard
      - key: BRAINTRUST_PROJECT_ID
        sync: false # Add via Render dashboard
      # SENTRY error tracking and source maps
      - key: SENTRY_DSN
        sync: false # Add via Render dashboard
      - key: SENTRY_AUTH_TOKEN
        sync: false # Required for source maps upload during build
      - key: SENTRY_ORG
        sync: false # Your Sentry organization slug
      - key: SENTRY_PROJECT
        sync: false # Your Sentry project slug
    healthCheckPath: /health
    disk:
      name: lifebuild-data
      mountPath: /var/data
      sizeGB: 10
    # Disk-attached services cannot use autoscaling.
    numInstances: 1
  # Cron jobs for backup (from ADR-002)
  - type: cron
    name: backup-job
    runtime: node
    schedule: '0 */6 * * *' # Every 6 hours
    buildCommand: pnpm install
    startCommand: echo "Backup job placeholder - implement later"
