services:
  - type: web
    name: work-squared-server
    runtime: node
    plan: starter
    # Build from monorepo root to access workspace dependencies
    rootDir: .
    buildCommand: |
      # Install dependencies
      pnpm install &&
      # Rebuild better-sqlite3 native bindings for production environment
      cd node_modules/.pnpm/better-sqlite3@11.10.0/node_modules/better-sqlite3 && npm run build-release &&
      cd - &&
      # Build the server
      pnpm --filter @work-squared/server build
    startCommand: pnpm --filter @work-squared/server start
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        fromService:
          type: web
          name: work-squared-server
          property: port
      - key: AUTH_TOKEN
        generateValue: true
      - key: LIVESTORE_SYNC_URL
        value: wss://app.worksquared.ai
      - key: SERVER_BYPASS_TOKEN
        sync: false
      - key: STORE_IDS
        value: work-squared-production,885773a8-b433-47bd-8ee4-a907a79922d8,11d1a22c-3462-43aa-988a-3cf11b95f03b,d56d28db-bc17-406d-8204-4dd24d17c5ac,70fb4e45-7677-4b70-9e46-3c2e4f3cbd0a
      - key: STORE_DATA_PATH
        value: /var/data
      # Message processing cutoff - messages before this timestamp are skipped (temporary)
      - key: MESSAGE_PROCESSING_CUTOFF_TIMESTAMP
        value: 2025-09-01T00:00:00.000Z
      # Store Connection Settings
      - key: STORE_CONNECTION_TIMEOUT
        value: 30000
      - key: STORE_RECONNECT_INTERVAL
        value: 5000
      - key: STORE_MAX_RECONNECT_ATTEMPTS
        value: 3
      # DevTools (disabled in production)
      - key: DISABLE_DEVTOOLS
        value: true
      # BRAINTRUST credentials for server-side agentic loop
      - key: BRAINTRUST_API_KEY
        sync: false # Add via Render dashboard
      - key: BRAINTRUST_PROJECT_ID
        sync: false # Add via Render dashboard
    healthCheckPath: /health
    disk:
      name: work-squared-data
      mountPath: /var/data
      sizeGB: 10
    # Scaling configuration from ADR-002
    scaling:
      minInstances: 1
      maxInstances: 3
      targetCPUPercent: 70

# Cron jobs for backup (from ADR-002)
crons:
  - type: worker
    name: backup-job
    runtime: node
    schedule: '0 */6 * * *' # Every 6 hours
    buildCommand: pnpm install
    startCommand: echo "Backup job placeholder - implement later"
